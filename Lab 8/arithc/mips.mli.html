<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="c">(* Library to generate MIPS code</span>

<span class="c">   by 2008 Jean-Christophe Filliâtre (CNRS)</span>
<span class="c">   - first version</span>

<span class="c">   2013 Kim Nguyen (Université Paris Sud)</span>
<span class="c">   - subtypes text and data</span>
<span class="c">   - ghost types for oreg and oi</span>
<span class="c">   - more ops and directives</span>
<span class="c">   - stack management</span>
<span class="c">   - ocamldoc xs</span>

<span class="c">   2024 Léon Gondelman (AAU)</span>
<span class="c">   - just translated to English description</span>
<span class="c">*)</span>

<span class="c">(** {0 Library for writing MIPS programs } *)</span>


<span class="c">(** Module {!Mips} allows to write MIPS code inside OCaml code without</span>
<span class="c">    need for a preprocessor. A complete example is given in</span>
<span class="c">    {{:#1_Exemple} below in the section example}. *)</span>

<span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">asm</span>
<span class="c">(** abstract type to represent assembly code. The parameter</span>
<span class="c">    [&#39;a] is used as ghost type. *)</span>

<span class="k">type</span> <span class="n">text</span> <span class="o">=</span> <span class="o">[</span> <span class="o">`</span><span class="n">text</span> <span class="o">]</span> <span class="n">asm</span>
<span class="c">(** type representing assembly code in the section following the text directive. *)</span>

<span class="k">type</span> <span class="n">data</span> <span class="o">=</span> <span class="o">[</span> <span class="o">`</span><span class="n">data</span> <span class="o">]</span> <span class="n">asm</span>
<span class="c">(** type representing assembly code in the section following the data directive. *)</span>

<span class="k">type</span> <span class="n">program</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">text</span> <span class="o">:</span> <span class="n">text</span><span class="o">;</span>
  <span class="n">data</span> <span class="o">:</span> <span class="n">data</span><span class="o">;</span>
<span class="o">}</span>
<span class="c">(** a program consists of a text zone and data zone *)</span>

<span class="k">val</span> <span class="n">print_program</span> <span class="o">:</span> <span class="nn">Format</span><span class="p">.</span><span class="n">formatter</span> <span class="o">-&gt;</span> <span class="n">program</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="c">(** [print_program fmt p] pretty-printsthe code of the program [p] in the formatter</span>
<span class="c">      [fmt] *)</span>

<span class="k">val</span> <span class="n">print_in_file</span><span class="o">:</span> <span class="n">file</span><span class="o">:</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">program</span> <span class="o">-&gt;</span> <span class="kt">unit</span>

<span class="k">type</span> <span class="n">register</span>
<span class="c">(** Abstract type for registers *)</span>

<span class="k">val</span> <span class="n">v0</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">v1</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">a0</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">a1</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">a2</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">a3</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">t0</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">t1</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">t2</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">t3</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">s0</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">s1</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">ra</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">sp</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">fp</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">gp</span> <span class="o">:</span> <span class="n">register</span>
<span class="k">val</span> <span class="n">zero</span> <span class="o">:</span> <span class="n">register</span>
<span class="c">(** Constantes representing the registrers. [zero] is fixed to 0 *)</span>


<span class="k">type</span> <span class="n">label</span> <span class="o">=</span> <span class="kt">string</span>
<span class="c">(** Address labes are represented by strings. *)</span>

<span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">operand</span>
<span class="k">val</span> <span class="n">oreg</span> <span class="o">:</span> <span class="n">register</span> <span class="n">operand</span>
<span class="k">val</span> <span class="n">oi</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">operand</span>
<span class="k">val</span> <span class="n">oi32</span> <span class="o">:</span> <span class="n">int32</span> <span class="n">operand</span>

<span class="c">(** abstract type to represent the last operand of an arithmetic expression</span>
<span class="c">    as well as 3 constants (either a register, or an integer, or a 32b integer).</span>
<span class="c">*)</span>



<span class="c">(** {1 Arithmetic operations } *)</span>


<span class="k">val</span> <span class="n">li</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">li32</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">int32</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** Loading integer constants *)</span>

<span class="k">val</span> <span class="n">abs</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [abs r1 r2] stores in r1 the absolute value of r2 *)</span>

<span class="k">val</span> <span class="n">neg</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [neg r1 r2] stores in r1 the opposite of r2 *)</span>

<span class="k">val</span> <span class="n">add</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">operand</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">sub</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">operand</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">mul</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">operand</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">rem</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">operand</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">div</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">operand</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>

<span class="c">(** The 5 base arithmetic operations: [add rdst rsrc1 ospec o]</span>
<span class="c">    stores destination register rdst the result of operation between source register rscr1 and o.</span>
<span class="c">    The constant ospec specifies whether o is an immediate, an immediate over 32 bits or a register.</span>
<span class="c">    Example:</span>

<span class="c">   [add v0 v1 oreg v2]</span>

<span class="c">   [div v0 v1 oi 424]</span>

<span class="c">   [sub t0 a0 oi32 2147483647l]</span>
<span class="c"> *)</span>

<span class="c">(** {1 Logical Operations } *)</span>

<span class="k">val</span> <span class="n">and_</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">or_</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">not_</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">clz</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** Logical operations &quot;and&quot;, &quot;or&quot;, and &quot;not&quot; manipulating bits pointwise</span>
<span class="c">    and &quot;clz&quot; (counting leading zero) *)</span>


<span class="c">(** {1 Comparisons } *)</span>

<span class="k">val</span> <span class="n">seq</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">sge</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">sgt</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">sle</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">slt</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">sne</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
  <span class="c">(** conditional [sop ra rb rc] sets [ra] to 1 if [rb op rc] and to 0</span>
<span class="c">      otherwise (eq : ==, ge : &gt;=, gt : &gt;, le : &lt;=, lt : &lt;=,</span>
<span class="c">      ne : !=) *)</span>

<span class="c">(** {1 Jumps } *)</span>

<span class="k">val</span> <span class="n">b</span> <span class="o">:</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** unconditional jump *)</span>

<span class="k">val</span> <span class="n">beq</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">bne</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">bge</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">bgt</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">ble</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">blt</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [bop ra rb label] branches to the label [label] if [ra op rb] *)</span>

<span class="k">val</span> <span class="n">beqz</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">bnez</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">bgez</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">bgtz</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">blez</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span>  <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="k">val</span> <span class="n">bltz</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span>  <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [bopz ra rb label] branchse to le label [label] if [ra op 0] *)</span>


<span class="k">val</span> <span class="n">jr</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [jr r] Continues the execution at the address specified by the register [r] *)</span>
<span class="k">val</span> <span class="n">jal</span> <span class="o">:</span> <span class="n">label</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [jal l] Continues the execution at the address specified by the label [l],</span>
<span class="c">    and stores the return address in $ra.</span>
<span class="c">*)</span>
<span class="k">val</span> <span class="n">jalr</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [jalr r]  Continues the execution at the address specified by the</span>
<span class="c">    register [r], and stores the return address in $ra.</span>
<span class="c">*)</span>

<span class="c">(** {1 Reading from / writing to the memory } *)</span>

<span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">address</span>
<span class="c">(** abstract type to represent memory addresses *)</span>

<span class="k">val</span> <span class="n">alab</span> <span class="o">:</span> <span class="n">label</span> <span class="n">address</span>
<span class="k">val</span> <span class="n">areg</span> <span class="o">:</span> <span class="o">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">register</span><span class="o">)</span> <span class="n">address</span>
<span class="c">(** The adresses are either given by a label, or by a pair (offset, register) *)</span>

<span class="k">val</span> <span class="n">la</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [la reg alab &quot;foo&quot;] stores in [reg] the address of the label &quot;foo&quot;</span>
<span class="c">    [la reg1 areg (x, reg2)] stores in [reg1] the address stores in the register</span>
<span class="c">    [reg2] at the offset of [x] octets</span>
<span class="c"> *)</span>

<span class="k">val</span> <span class="n">lbu</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** stores the octet at a given address without sign extension (value between 0 and 255) *)</span>
<span class="k">val</span> <span class="n">lw</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** stores 32bits integer at a given address *)</span>
<span class="k">val</span> <span class="n">sb</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** writes the 8 least significant bits of a given register at a given address *)</span>
<span class="k">val</span> <span class="n">sw</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">address</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** write the content of the register at a given address *)</span>
<span class="k">val</span> <span class="n">move</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>

<span class="c">(** {1 Miscellaneous } *)</span>

<span class="k">val</span> <span class="n">nop</span> <span class="o">:</span> <span class="o">[&gt;</span> <span class="o">]</span> <span class="n">asm</span>
<span class="c">(** Empty instruction instruction. Can be used both in .text and .data *)</span>

<span class="k">val</span> <span class="n">label</span> <span class="o">:</span> <span class="n">label</span> <span class="o">-&gt;</span>  <span class="o">[&gt;</span> <span class="o">]</span> <span class="n">asm</span>
<span class="c">(** A label. Can be used both in .text and .data *)</span>

<span class="k">val</span> <span class="n">syscall</span> <span class="o">:</span> <span class="n">text</span>
<span class="c">(** System call instruction *)</span>

<span class="k">val</span> <span class="n">comment</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="o">[&gt;</span> <span class="o">]</span> <span class="n">asm</span>
<span class="c">(** Includes a comment in the generated code. Can be used both in .text and .data *)</span>

<span class="k">val</span> <span class="n">align</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span>  <span class="o">[&gt;</span> <span class="o">]</span> <span class="n">asm</span>
<span class="c">(** [align n] alignes the code following an instruction on 2^n octets *)</span>

<span class="k">val</span> <span class="n">asciiz</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">data</span>
<span class="c">(** places a string value in the data zone *)</span>

<span class="k">val</span> <span class="n">dword</span> <span class="o">:</span> <span class="kt">int</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">data</span>
<span class="c">(** places a list of memory words in the data zone *)</span>

<span class="k">val</span> <span class="n">address</span> <span class="o">:</span> <span class="n">label</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">data</span>
<span class="c">(** places a list of adresses (denoted by labels) in data zone *)</span>

<span class="k">val</span> <span class="n">space</span><span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">data</span>
<span class="c">(** [space n] allocates [n] octets in the data segment *)</span>

<span class="k">val</span> <span class="n">inline</span><span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="o">[&gt;</span> <span class="o">]</span> <span class="n">asm</span>
<span class="c">(** [inline s] copies the string  [s] as such in the assembly file *)</span>

<span class="k">val</span> <span class="o">(</span> <span class="o">++</span> <span class="o">)</span> <span class="o">:</span> <span class="o">([&lt;</span> <span class="o">`</span><span class="n">text</span><span class="o">|`</span><span class="n">data</span> <span class="o">]</span> <span class="n">asm</span> <span class="k">as</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
<span class="c">(** concatenates two pieces of code (either text with text, or data with</span>
<span class="c">    data) *)</span>

<span class="c">(** {1 Manipulation of the stack} *)</span>

<span class="k">val</span> <span class="n">push</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [push r] stores the content of [r] at the top of the stack</span>
<span class="c">    Note : $sp points to the addrees of the last occupied cell of the stack *)</span>

<span class="k">val</span> <span class="n">pop</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [pop r] stores the mot at the top of the stack in [r] et pops the stack head *)</span>

<span class="k">val</span> <span class="n">popn</span><span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [popn n] pops [n] octets from the stack *)</span>

<span class="k">val</span> <span class="n">peek</span> <span class="o">:</span> <span class="n">register</span> <span class="o">-&gt;</span> <span class="n">text</span>
<span class="c">(** [peek r] stores the word at the stack head in [r] without popping the stack head *)</span>

<span class="c">(** {1 Example } *)</span>

<span class="c">(** In the the program below, on the left is pure MIPS code and on the right is</span>
<span class="c">    its representation using OCaml commands above. The program loads two</span>
<span class="c">    constants, performs a few arithmetic  operations and prints the result on</span>
<span class="c">    the screen.</span>

<span class="c">    {[</span>
<span class="c">        .text                                                |  { text =</span>
<span class="c">        main:                                                |        label &quot;main&quot;</span>
<span class="c">         #stores 42 in $a0 and 23 in $a1                     |    ++  comment &quot;stores 42 in $a0 and 23 in $a1&quot;</span>
<span class="c">         li $a0,  42                                         |    ++  li  a0 42</span>
<span class="c">         li $a1,  23                                         |    ++  li  a1 23</span>
<span class="c">         mul $a0, $a0, $a1                                   |    ++  mul a0 a0 oreg a1 (* we use  oreg to indicate that the</span>
<span class="c">                                                             |                             last operand is a register *)</span>
<span class="c">         #stores the content of $a0 on the stack             |    ++  comment &quot;stores the content of $a0 on the stack&quot;</span>
<span class="c">         sub $sp, $sp, 4                                     |    ++  sub sp sp oi 4</span>
<span class="c">         sw  $a0,  0($sp)                                    |    ++  sw a0 areg (0, sp)</span>
<span class="c">                                                             |</span>
<span class="c">         jal print_int                                       |    ++  jal &quot;print_int&quot;</span>
<span class="c">                                                             |</span>
<span class="c">         #termines                                           |    ++  comment &quot;termines&quot;</span>
<span class="c">         li $v0, 10                                          |    ++  li v0 10</span>
<span class="c">         syscall                                             |    ++  syscall</span>
<span class="c">                                                             |</span>
<span class="c">      print_int:                                             |    ++  label &quot;print_int&quot;</span>
<span class="c">         lw $a0,  0($sp)                                     |    ++  lw a0 areg (0, sp)</span>
<span class="c">         add $sp, $sp, 4                                     |    ++  add sp sp oi 4</span>
<span class="c">         li $v0, 1                                           |    ++  li v0 1</span>
<span class="c">         syscall                                             |    ++  syscall</span>
<span class="c">         la $a0, newline                                     |    ++  la a0 alab &quot;newline&quot;</span>
<span class="c">         li $v0, 4                                           |    ++  li v0  4</span>
<span class="c">         syscall                                             |    ++  syscall</span>
<span class="c">         jr $ra                                              |    ++  jr ra  ; (* end the of text label *)</span>
<span class="c">                                                             |</span>
<span class="c">        .data                                                |    data =</span>
<span class="c">       newline:                                              |        label &quot;newline&quot;</span>
<span class="c">        .asciiz  &quot;\n&quot;                                        |    ++  asciiz &quot;\n&quot; ;</span>
<span class="c">                                                             |  } (* end of the OCaml record *)</span>
<span class="c">    ]}</span>
<span class="c">*)</span>
</pre></div>
</body>
</html>
